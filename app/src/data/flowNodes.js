// Lloyd's Register Rules - Decision Tree State Machine
// Each node represents a step in the flowchart wizard

export const GRADE_INFO = {
  EH36: { label: 'Grade EH36', color: '#3b82f6', desc: 'Higher-strength steel, 36 kgf/mm² yield' },
  EH40: { label: 'Grade EH40', color: '#8b5cf6', desc: 'Higher-strength steel, 40 kgf/mm² yield' },
  EH47: { label: 'Grade EH47', color: '#f59e0b', desc: 'Higher-strength steel, 47 kgf/mm² yield' },
};

export const GRADE_STARTS = {
  EH36: 'eh36_q1',
  EH40: 'eh40_q1',
  EH47: 'eh47_q1',
};

/** Build a { root, nodes } flow object for a given grade. */
export function buildGradeFlow(grade) {
  return { root: GRADE_STARTS[grade], nodes: FLOW_NODES };
}

export const FLOW_NODES = {
  // ─── EH36 ───────────────────────────────────────
  eh36_q1: {
    type: 'question',
    title: 'Thickness Check',
    text: 'Is hatch coaming thickness t > 85 mm?',
    view: 'A',
    highlights: ['coaming-top', 'coaming-side'],
    highlightColor: '#60a5fa',
    yes: 'eh36_m1',
    no: 'eh36_standard',
  },
  eh36_standard: {
    type: 'terminal',
    title: 'No Additional Measures',
    text: 'Standard materials — no additional crack arrest measures required for EH36.',
    view: 'A',
    highlights: [],
    highlightColor: '#22c55e',
    icon: 'check',
  },
  eh36_m1: {
    type: 'terminal',
    title: 'Measure 1 — 100% NDE',
    text: '100% NDE (Non-Destructive Examination) on all upper flange longitudinal members at block-to-block butt welds.',
    view: 'B',
    highlights: ['transverse-butt'],
    highlightColor: '#00e5ff',
    tooltip: 'Measure 1: 100% UT strictly applies to Block-to-Block Butt Welds',
    icon: 'scan',
  },

  // ─── EH40 ───────────────────────────────────────
  eh40_q1: {
    type: 'question',
    title: 'Thickness Check',
    text: 'Is hatch coaming top plate or side plate thickness t > 85 mm?',
    view: 'A',
    highlights: ['coaming-top', 'coaming-side'],
    highlightColor: '#60a5fa',
    yes: 'eh40_q2',
    no: 'eh40_m1_direct',
  },
  eh40_m1_direct: {
    type: 'terminal',
    title: 'Measure 1 — 100% NDE',
    text: '100% NDE on all upper flange longitudinal members at block-to-block butt welds.',
    view: 'B',
    highlights: ['transverse-butt'],
    highlightColor: '#00e5ff',
    tooltip: 'Measure 1: 100% UT strictly applies to Block-to-Block Butt Welds',
    icon: 'scan',
  },
  eh40_q2: {
    type: 'question',
    title: 'Crack Arrest Design',
    text: 'Will a crack arrest design approach be adopted?',
    view: 'A',
    highlights: ['coaming-top', 'coaming-side'],
    highlightColor: '#60a5fa',
    yes: 'eh40_ca_m3',
    no: 'eh40_noca_m3',
  },

  // ─── EH40: Crack Arrest YES Branch ──────────────
  eh40_ca_m3: {
    type: 'info',
    title: 'Measure 3 — Crack Arrest Steel',
    text: 'Crack arrest steel (BCA grade) required for hatch coaming plates.',
    view: 'A',
    highlights: ['coaming-top', 'coaming-side'],
    highlightColor: '#ffab00',
    icon: 'shield',
    next: 'eh40_ca_q3',
  },
  eh40_ca_q3: {
    type: 'question',
    title: 'Side Plate Thickness',
    text: 'Is hatch coaming side plate thickness t > 80 mm?',
    view: 'A',
    highlights: ['coaming-side'],
    highlightColor: '#60a5fa',
    yes: 'eh40_ca_bca2',
    no: 'eh40_ca_bca1',
  },
  eh40_ca_bca2: {
    type: 'info',
    title: 'BCA2 Steel Required',
    text: 'BCA2 (Brittle Crack Arrest Grade 2) steel required for hatch coaming side plate. Higher toughness grade.',
    view: 'A',
    highlights: ['coaming-side'],
    highlightColor: '#facc15',
    icon: 'shield',
    next: 'eh40_ca_blockshift',
  },
  eh40_ca_bca1: {
    type: 'info',
    title: 'BCA1 Steel Required',
    text: 'BCA1 (Brittle Crack Arrest Grade 1) steel required for hatch coaming side plate.',
    view: 'A',
    highlights: ['coaming-side'],
    highlightColor: '#facc15',
    icon: 'shield',
    next: 'eh40_ca_blockshift',
  },
  eh40_ca_blockshift: {
    type: 'info',
    title: 'Block Shift / Insert Plates',
    text: 'Block shift arrangement or crack arrest insert plates/holes at transverse butt joints.',
    view: 'B',
    highlights: ['block-shift'],
    highlightColor: '#f59e0b',
    icon: 'layers',
    next: 'eh40_ca_welding',
  },
  eh40_ca_welding: {
    type: 'info',
    title: 'Welding Process',
    text: 'FCAW (Flux-Cored Arc Welding), GMAW (Gas Metal Arc Welding), or EGW (Electro-Gas Welding) process required.',
    view: 'B',
    highlights: [],
    highlightColor: '#f59e0b',
    icon: 'zap',
    next: 'eh40_ca_m45',
  },
  eh40_ca_m45: {
    type: 'info',
    title: 'Measures 4 & 5 — Deck & Sheer Strake',
    text: 'Crack arrest steel (BCA1) required for upper deck plate and sheer strake in way of hatch coaming.',
    view: 'A',
    highlights: ['upper-deck', 'sheer-strake'],
    highlightColor: '#00e676',
    icon: 'shield',
    next: 'eh40_ca_m1',
  },
  eh40_ca_m1: {
    type: 'terminal',
    title: 'Measure 1 — 100% NDE',
    text: '100% NDE on all upper flange longitudinal members at block-to-block butt welds.',
    view: 'B',
    highlights: ['transverse-butt'],
    highlightColor: '#00e5ff',
    tooltip: 'Measure 1: 100% UT strictly applies to Block-to-Block Butt Welds',
    icon: 'scan',
  },

  // ─── EH40: No Crack Arrest Branch ──────────────
  eh40_noca_m3: {
    type: 'info',
    title: 'Measure 3 — Enhanced NDE',
    text: 'Enhanced NDE with stricter acceptance criteria. CTOD testing based on LR ShipRight procedures.',
    view: 'B',
    highlights: ['intersections'],
    highlightColor: '#ff1744',
    tooltip: 'CTOD test based on LR ShipRight',
    icon: 'alert',
    next: 'eh40_noca_shipright',
  },
  eh40_noca_shipright: {
    type: 'info',
    title: 'ShipRight Procedure',
    text: 'ShipRight FDA (Fatigue Design Assessment) and SDA (Structural Detail Analysis) procedures apply.',
    view: 'B',
    highlights: ['intersections'],
    highlightColor: '#ff1744',
    icon: 'info',
    next: 'eh40_noca_welding',
  },
  eh40_noca_welding: {
    type: 'info',
    title: 'Welding Process',
    text: 'FCAW / GMAW welding process required for all critical joints.',
    view: 'B',
    highlights: [],
    highlightColor: '#f59e0b',
    icon: 'zap',
    next: 'eh40_noca_m2',
  },
  eh40_noca_m2: {
    type: 'info',
    title: 'Measure 2 — In-Service NDE',
    text: 'Periodic in-service NDE inspection at all transverse butt joints.',
    view: 'B',
    highlights: ['radar'],
    highlightColor: '#00e5ff',
    icon: 'scan',
    next: 'eh40_noca_m45',
  },
  eh40_noca_m45: {
    type: 'info',
    title: 'Measures 4 & 5 — Deck & Sheer Strake',
    text: 'Crack arrest steel (BCA1) for upper deck plate and sheer strake.',
    view: 'A',
    highlights: ['upper-deck', 'sheer-strake'],
    highlightColor: '#00e676',
    icon: 'shield',
    next: 'eh40_noca_m1',
  },
  eh40_noca_m1: {
    type: 'terminal',
    title: 'Measure 1 — 100% NDE',
    text: '100% NDE on all upper flange longitudinal members at block-to-block butt welds.',
    view: 'B',
    highlights: ['transverse-butt'],
    highlightColor: '#00e5ff',
    tooltip: 'Measure 1: 100% UT strictly applies to Block-to-Block Butt Welds',
    icon: 'scan',
  },

  // ─── EH47 ───────────────────────────────────────
  // EH47 starts directly at the crack arrest design question
  eh47_q1: {
    type: 'question',
    title: 'Crack Arrest Design',
    text: 'Will a crack arrest design approach be adopted?',
    view: 'A',
    highlights: ['coaming-top', 'coaming-side'],
    highlightColor: '#60a5fa',
    yes: 'eh47_ca_m3',
    no: 'eh47_noca_m3',
  },

  // ─── EH47: Crack Arrest YES Branch ─────────────
  eh47_ca_m3: {
    type: 'info',
    title: 'Measure 3 — Crack Arrest Steel',
    text: 'Crack arrest steel (BCA grade) required for hatch coaming plates.',
    view: 'A',
    highlights: ['coaming-top', 'coaming-side'],
    highlightColor: '#ffab00',
    icon: 'shield',
    next: 'eh47_ca_q3',
  },
  eh47_ca_q3: {
    type: 'question',
    title: 'Side Plate Thickness',
    text: 'Is hatch coaming side plate thickness t > 80 mm?',
    view: 'A',
    highlights: ['coaming-side'],
    highlightColor: '#60a5fa',
    yes: 'eh47_ca_bca2',
    no: 'eh47_ca_bca1',
  },
  eh47_ca_bca2: {
    type: 'info',
    title: 'BCA2 Steel Required',
    text: 'BCA2 (Brittle Crack Arrest Grade 2) steel required for hatch coaming side plate. Higher toughness.',
    view: 'A',
    highlights: ['coaming-side'],
    highlightColor: '#facc15',
    icon: 'shield',
    next: 'eh47_ca_blockshift',
  },
  eh47_ca_bca1: {
    type: 'info',
    title: 'BCA1 Steel Required',
    text: 'BCA1 (Brittle Crack Arrest Grade 1) steel required for hatch coaming side plate.',
    view: 'A',
    highlights: ['coaming-side'],
    highlightColor: '#facc15',
    icon: 'shield',
    next: 'eh47_ca_blockshift',
  },
  eh47_ca_blockshift: {
    type: 'info',
    title: 'Block Shift / Insert Plates',
    text: 'Block shift arrangement or crack arrest insert plates/holes at transverse butt joints.',
    view: 'B',
    highlights: ['block-shift'],
    highlightColor: '#f59e0b',
    icon: 'layers',
    next: 'eh47_ca_welding',
  },
  eh47_ca_welding: {
    type: 'info',
    title: 'Welding Process',
    text: 'FCAW / GMAW / EGW welding process required.',
    view: 'B',
    highlights: [],
    highlightColor: '#f59e0b',
    icon: 'zap',
    next: 'eh47_ca_m45',
  },
  eh47_ca_m45: {
    type: 'info',
    title: 'Measures 4 & 5 — Deck & Sheer Strake',
    text: 'Crack arrest steel (BCA1) for upper deck plate and sheer strake.',
    view: 'A',
    highlights: ['upper-deck', 'sheer-strake'],
    highlightColor: '#00e676',
    icon: 'shield',
    next: 'eh47_ca_m1',
  },
  eh47_ca_m1: {
    type: 'terminal',
    title: 'Measure 1 — 100% NDE',
    text: '100% NDE on all upper flange longitudinal members at block-to-block butt welds.',
    view: 'B',
    highlights: ['transverse-butt'],
    highlightColor: '#00e5ff',
    tooltip: 'Measure 1: 100% UT strictly applies to Block-to-Block Butt Welds',
    icon: 'scan',
  },

  // ─── EH47: No Crack Arrest Branch ─────────────
  eh47_noca_m3: {
    type: 'info',
    title: 'Measure 3 — Enhanced NDE',
    text: 'Enhanced NDE with stricter acceptance criteria. CTOD testing based on LR ShipRight.',
    view: 'B',
    highlights: ['intersections'],
    highlightColor: '#ff1744',
    tooltip: 'CTOD test based on LR ShipRight',
    icon: 'alert',
    next: 'eh47_noca_shipright',
  },
  eh47_noca_shipright: {
    type: 'info',
    title: 'ShipRight Procedure',
    text: 'ShipRight FDA and SDA procedures apply.',
    view: 'B',
    highlights: ['intersections'],
    highlightColor: '#ff1744',
    icon: 'info',
    next: 'eh47_noca_welding',
  },
  eh47_noca_welding: {
    type: 'info',
    title: 'Welding Process',
    text: 'FCAW / GMAW welding process required.',
    view: 'B',
    highlights: [],
    highlightColor: '#f59e0b',
    icon: 'zap',
    next: 'eh47_noca_m2',
  },
  eh47_noca_m2: {
    type: 'info',
    title: 'Measure 2 — In-Service NDE',
    text: 'Periodic in-service NDE at all transverse butt joints.',
    view: 'B',
    highlights: ['radar'],
    highlightColor: '#00e5ff',
    icon: 'scan',
    next: 'eh47_noca_m45',
  },
  eh47_noca_m45: {
    type: 'info',
    title: 'Measures 4 & 5 — Deck & Sheer Strake',
    text: 'Crack arrest steel (BCA1) for upper deck plate and sheer strake.',
    view: 'A',
    highlights: ['upper-deck', 'sheer-strake'],
    highlightColor: '#00e676',
    icon: 'shield',
    next: 'eh47_noca_m1',
  },
  eh47_noca_m1: {
    type: 'terminal',
    title: 'Measure 1 — 100% NDE',
    text: '100% NDE on all upper flange longitudinal members at block-to-block butt welds.',
    view: 'B',
    highlights: ['transverse-butt'],
    highlightColor: '#00e5ff',
    tooltip: 'Measure 1: 100% UT strictly applies to Block-to-Block Butt Welds',
    icon: 'scan',
  },
};
