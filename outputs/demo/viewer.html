<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hatch Coaming 3D Viewer – TC-002-HIGH</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Segoe UI', Arial, sans-serif; background: #1a1a2e; color: #eee; overflow: hidden; }
  #canvas-container { width: 100vw; height: 100vh; }
  canvas { display: block; }
  #legend {
    position: absolute; top: 16px; right: 16px;
    background: rgba(30,30,60,0.92); border-radius: 10px;
    padding: 16px; min-width: 200px; box-shadow: 0 2px 16px rgba(0,0,0,0.4);
  }
  #legend h3 { margin-bottom: 10px; font-size: 14px; color: #aaa; }
  .legend-item {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 6px; cursor: pointer; user-select: none;
  }
  .legend-swatch { width: 16px; height: 16px; border-radius: 3px; border: 1px solid #555; }
  .legend-label { font-size: 12px; }
  .legend-item.disabled .legend-label { text-decoration: line-through; opacity: 0.4; }
  .legend-item.disabled .legend-swatch { opacity: 0.3; }
  #popup {
    display: none; position: absolute; bottom: 20px; left: 20px;
    background: rgba(30,30,60,0.95); border-radius: 10px;
    padding: 16px; max-width: 420px; max-height: 60vh; overflow-y: auto;
    box-shadow: 0 2px 16px rgba(0,0,0,0.5); font-size: 12px;
  }
  #popup h3 { color: #4fc3f7; margin-bottom: 8px; }
  #popup .measure-block { margin-bottom: 10px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; }
  #popup .measure-block h4 { color: #ffb74d; }
  #popup .req { margin: 4px 0; padding-left: 10px; border-left: 2px solid #666; }
  #popup .close-btn {
    position: absolute; top: 8px; right: 12px; cursor: pointer;
    font-size: 18px; color: #888;
  }
  #popup .close-btn:hover { color: #fff; }
  #info-bar {
    position: absolute; bottom: 0; left: 0; right: 0;
    background: rgba(30,30,60,0.85); padding: 8px 16px;
    font-size: 11px; color: #888; text-align: center;
  }
</style>
</head>
<body>
<div id="canvas-container"></div>
<div id="legend">
  <h3>Measure Legend</h3>
  <div id="legend-items"></div>
</div>
<div id="popup">
  <span class="close-btn" onclick="document.getElementById('popup').style.display='none'">&times;</span>
  <div id="popup-content"></div>
</div>
<div id="info-bar">
  Project: TC-002-HIGH | t_control: 95.0 mm |
  y_control: 460.0 N/mm² |
  Global measures: [1, 3, 4, 5] |
  Click on objects for measure details
</div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>
<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

const targetInfo = {"J01": {"target_id": "J01", "target_type": "joint", "measures": [{"measure_id": 1, "status": "applied", "requirements": ["NDE: UT 100% of block-to-block butt welds"], "rule_ref": "Block-to-block butt welds in adjacent strakes shall be staggered by at least 300 mm.", "notes": []}, {"measure_id": 2, "status": "conditional", "requirements": ["Periodic in-service NDE required", "Frequency and extent to be agreed with LR"], "rule_ref": "Where enhanced NDE is selected as the crack arrest measure, stricter acceptance criteria per ShipRight procedure apply. CTOD value shall be not less than 0.18 mm. Electrogas welding (EGW) is not permitted.", "notes": ["Conditional per Note 2"]}, {"measure_id": 3, "status": "applied", "requirements": ["Enhanced NDE method: PAUT", "Stricter acceptance criteria per ShipRight procedure apply", "CTOD >= 0.18 mm required", "Electrogas welding (EGW) is NOT permitted"], "rule_ref": "Where enhanced NDE is selected as the crack arrest measure, stricter acceptance criteria per ShipRight procedure apply. CTOD value shall be not less than 0.18 mm. Electrogas welding (EGW) is not permitted.", "notes": []}]}, "J02": {"target_id": "J02", "target_type": "joint", "measures": [{"measure_id": 1, "status": "applied", "requirements": ["NDE: UT 100% of block-to-block butt welds"], "rule_ref": "Block-to-block butt welds in adjacent strakes shall be staggered by at least 300 mm.", "notes": []}, {"measure_id": 2, "status": "conditional", "requirements": ["Periodic in-service NDE required", "Frequency and extent to be agreed with LR"], "rule_ref": "Where enhanced NDE is selected as the crack arrest measure, stricter acceptance criteria per ShipRight procedure apply. CTOD value shall be not less than 0.18 mm. Electrogas welding (EGW) is not permitted.", "notes": ["Conditional per Note 2"]}, {"measure_id": 3, "status": "applied", "requirements": ["Enhanced NDE method: PAUT", "Stricter acceptance criteria per ShipRight procedure apply", "CTOD >= 0.18 mm required", "Electrogas welding (EGW) is NOT permitted"], "rule_ref": "Where enhanced NDE is selected as the crack arrest measure, stricter acceptance criteria per ShipRight procedure apply. CTOD value shall be not less than 0.18 mm. Electrogas welding (EGW) is not permitted.", "notes": []}]}, "J03": {"target_id": "J03", "target_type": "joint", "measures": [{"measure_id": 0, "status": "applied", "requirements": ["LR-approved partial joint penetration (PJP) welding REQUIRED"], "rule_ref": "The connection of hatch coaming to upper deck shall be made using LR-approved partial joint penetration (PJP) welding.", "notes": ["Welding detail rule – always applicable for coaming-to-deck connections"]}]}, "J04": {"target_id": "J04", "target_type": "joint", "measures": [{"measure_id": 1, "status": "applied", "requirements": ["NDE: UT 100% of block-to-block butt welds"], "rule_ref": "Block-to-block butt welds in adjacent strakes shall be staggered by at least 300 mm.", "notes": []}, {"measure_id": 2, "status": "conditional", "requirements": ["Periodic in-service NDE required", "Frequency and extent to be agreed with LR"], "rule_ref": "Where enhanced NDE is selected as the crack arrest measure, stricter acceptance criteria per ShipRight procedure apply. CTOD value shall be not less than 0.18 mm. Electrogas welding (EGW) is not permitted.", "notes": ["Conditional per Note 2"]}, {"measure_id": 3, "status": "applied", "requirements": ["Enhanced NDE method: PAUT", "Stricter acceptance criteria per ShipRight procedure apply", "CTOD >= 0.18 mm required", "Electrogas welding (EGW) is NOT permitted"], "rule_ref": "Where enhanced NDE is selected as the crack arrest measure, stricter acceptance criteria per ShipRight procedure apply. CTOD value shall be not less than 0.18 mm. Electrogas welding (EGW) is not permitted.", "notes": []}]}, "M01": {"target_id": "M01", "target_type": "member", "measures": [{"measure_id": 4, "status": "applied", "requirements": ["Provide BCA steel – type: BCA2", "Per Table 8.2.2 for upper deck plate in cargo hold region"], "rule_ref": "The connection of hatch coaming to upper deck shall be made using LR-approved partial joint penetration (PJP) welding.", "notes": []}, {"measure_id": 5, "status": "applied", "requirements": ["Provide BCA steel (Measure 5) – type: BCA2", "Per Table 8.2.2 for upper deck plate (extended range, separate traceability)"], "rule_ref": "The connection of hatch coaming to upper deck shall be made using LR-approved partial joint penetration (PJP) welding.", "notes": []}]}, "M02": {"target_id": "M02", "target_type": "member", "measures": [{"measure_id": 3, "status": "applied", "requirements": ["Provide brittle crack arrest (BCA) steel – type: BCA2", "Per Table 8.2.2 for hatch coaming side plate"], "rule_ref": "Hatch coaming side plate in way of cargo hold region shall be provided with brittle crack arrest (BCA) steel.", "notes": []}]}};
const legendData = [{"id": 0, "label": "Measure 0", "color": "#888"}, {"id": 1, "label": "Measure 1 – Construction NDE", "color": "#FF8C00"}, {"id": 2, "label": "Measure 2 – Periodic In-service NDE", "color": "#1E90FF"}, {"id": 3, "label": "Measure 3 – Crack Arrest Measures", "color": "#DC143C"}, {"id": 4, "label": "Measure 4 – Upper Deck BCA Steel", "color": "#2E8B57"}, {"id": 5, "label": "Measure 5 – Upper Deck BCA Steel (extended)", "color": "#8A2BE2"}];

// Scene setup
const container = document.getElementById('canvas-container');
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x1a1a2e);

const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.01, 100);
camera.position.set(2, 1.5, 2);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
container.appendChild(renderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

// Lights
scene.add(new THREE.AmbientLight(0xffffff, 0.6));
const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
dirLight.position.set(5, 5, 5);
scene.add(dirLight);

// Grid
const grid = new THREE.GridHelper(4, 20, 0x444444, 0x333333);
scene.add(grid);

// Layer visibility
const measureVisibility = {};
legendData.forEach(item => { measureVisibility[item.id] = true; });

// Load GLB
const loader = new GLTFLoader();
let loadedScene = null;
loader.load('hatch_coaming.glb', (gltf) => {
  loadedScene = gltf.scene;
  scene.add(gltf.scene);

  // Center the model
  const box = new THREE.Box3().setFromObject(gltf.scene);
  const center = box.getCenter(new THREE.Vector3());
  controls.target.copy(center);
  camera.lookAt(center);
}, undefined, (error) => {
  console.warn('GLB load error:', error);
  // Add placeholder geometry
  const box = new THREE.Mesh(
    new THREE.BoxGeometry(1, 0.8, 0.2),
    new THREE.MeshStandardMaterial({ color: 0x888888, transparent: true, opacity: 0.5 })
  );
  scene.add(box);
});

// Legend
const legendContainer = document.getElementById('legend-items');
legendData.forEach(item => {
  const div = document.createElement('div');
  div.className = 'legend-item';
  div.innerHTML = `<div class="legend-swatch" style="background:${item.color}"></div><span class="legend-label">${item.label}</span>`;
  div.addEventListener('click', () => {
    measureVisibility[item.id] = !measureVisibility[item.id];
    div.classList.toggle('disabled');
    updateVisibility();
  });
  legendContainer.appendChild(div);
});

function updateVisibility() {
  if (!loadedScene) return;
  loadedScene.traverse((child) => {
    if (child.isMesh) {
      const name = child.name || child.parent?.name || '';
      const match = name.match(/_m(\d+)$/);
      if (match) {
        const mid = parseInt(match[1]);
        child.visible = measureVisibility[mid] !== false;
      }
    }
  });
}

// Raycaster for click
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

renderer.domElement.addEventListener('click', (event) => {
  mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
  mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);

  if (!loadedScene) return;
  const intersects = raycaster.intersectObjects(loadedScene.children, true);
  if (intersects.length > 0) {
    const obj = intersects[0].object;
    const name = obj.name || obj.parent?.name || '';

    // Extract target ID
    let targetId = null;
    const memberMatch = name.match(/^(member|joint)_([^_]+)/);
    if (memberMatch) targetId = memberMatch[2];

    if (targetId && targetInfo[targetId]) {
      showPopup(targetInfo[targetId]);
    }
  }
});

function showPopup(info) {
  const popup = document.getElementById('popup');
  const content = document.getElementById('popup-content');
  let html = `<h3>${info.target_type}: ${info.target_id}</h3>`;
  info.measures.forEach(m => {
    html += `<div class="measure-block">`;
    html += `<h4>Measure ${m.measure_id} (${m.status})</h4>`;
    m.requirements.forEach(r => {
      html += `<div class="req">${r}</div>`;
    });
    if (m.rule_ref && m.rule_ref !== '미지정') {
      html += `<div style="margin-top:4px;color:#aaa;font-size:11px">Ref: ${m.rule_ref.substring(0,120)}...</div>`;
    }
    if (m.notes && m.notes.length > 0) {
      html += `<div style="margin-top:4px;color:#ff8;font-size:11px">Notes: ${m.notes.join('; ')}</div>`;
    }
    html += `</div>`;
  });
  content.innerHTML = html;
  popup.style.display = 'block';
}

// Resize
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

// Animate
function animate() {
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>